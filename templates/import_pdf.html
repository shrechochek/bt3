<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Импорт PDF с олимпиадными заданиями</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;background:#f5f7fb}
    .box{max-width:800px;margin:24px auto;padding:24px;background:#fff;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    .drop{border:2px dashed #b6c2d3;border-radius:8px;padding:40px;text-align:center;color:#546a86;cursor:pointer}
    .drop.dragover{background:#eef6ff;border-color:#2b8dfc}
    input[type=file]{display:none}
    button{margin-top:12px;padding:10px 18px;border:none;border-radius:6px;background:#3498db;color:#fff;cursor:pointer}
    .info{margin-top:15px;padding:10px;background:#e8f5e8;border:1px solid #4caf50;border-radius:4px;color:#2e7d32}
    .back-link{color:#3498db;text-decoration: none;}
    .header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 20px;}
  </style>
</head>
<body>
  <div class="box">
    <div class="header">
      <h2>Импорт PDF с олимпиадными заданиями</h2>
      <a href="/" class="back-link">← На главную</a>
    </div>
    <p>Автоматический разбор PDF файлов с олимпиадными заданиями по биологии. Задания будут добавлены в базу данных с вариантами ответов и изображениями.</p>

    <div class="info">
      <strong>Поддерживаемые форматы:</strong><br>
      - Задания типа "Задание 1", "Задание 1.1"<br>
      - Варианты ответов: а), б), в), г)<br>
      - Изображения автоматически привязываются к заданиям<br>
      - Правильные ответы извлекаются из текста
    </div>

    <div id="drop" class="drop">
      Перетащите файл PDF сюда или нажмите, чтобы выбрать
    </div>

    <form id="uploadForm" method="post" enctype="multipart/form-data" style="display:none;">
      <input id="fileInput" type="file" name="file" accept="application/pdf" />
      <button id="submitBtn" type="submit">Импортировать задания</button>
    </form>

    <div id="status"></div>
  </div>

  <script>
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('fileInput');
  const status = document.getElementById('status');

  drop.addEventListener('click', () => fileInput.click());
  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
  drop.addEventListener('dragleave', e => { drop.classList.remove('dragover'); });

  drop.addEventListener('drop', e => {
    e.preventDefault();
    drop.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length) submitFile(files[0]);
  });

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length) submitFile(fileInput.files[0]);
  });

  function submitFile(file) {
    if (!file) return;
    if (!file.name.toLowerCase().endsWith('.pdf')) {
      status.innerText = "Нужен файл PDF";
      return;
    }
    status.innerText = "Импорт...";

    const fd = new FormData();
    fd.append('file', file);

    fetch('/import-pdf', {
      method: 'POST',
      body: fd,
      credentials: 'same-origin',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(async res => {
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        const data = await res.json();
        if (res.ok) {
          status.innerText = "Готово: " + (data.message || 'успех');
        } else {
          status.innerText = "Ошибка: " + (data.message || res.statusText);
        }
      } else {
        // возможно получен HTML (редирект на логин или ошибка)
        const text = await res.text();
        status.innerText = "Ответ сервера (HTML) — посмотрите консоль/логи сервера";
        console.log("Server HTML response:", text);
        // если это был редирект на логин — перенаправим
        if (res.redirected) window.location = res.url;
      }
    })
    .catch(err => {
      status.innerText = "Сетевая ошибка: " + err;
      console.error(err);
    });
  }
</script>
</body>
</html>
